<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenCode Web Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            height: 90vh;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            overflow: hidden;
        }

        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: 280px;
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: #475569;
        }

        .sidebar.collapsed .sidebar-header h2 {
            display: none;
        }

        .new-chat-btn {
            width: calc(100% - 40px);
            margin: 0 20px 15px;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .new-chat-btn:hover {
            transform: translateY(-2px);
        }

        .sidebar.collapsed .new-chat-btn {
            width: 40px;
            margin: 0 10px 15px;
            padding: 12px 0;
        }

        .sidebar.collapsed .new-chat-btn span {
            display: none;
        }

        .session-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 10px;
        }

        .session-item {
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .session-item:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .session-item.active {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-color: #667eea;
        }

        .session-item-title {
            font-size: 14px;
            font-weight: 500;
            color: #334155;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .session-item-info {
            font-size: 11px;
            color: #94a3b8;
            display: flex;
            justify-content: space-between;
        }

        .session-item-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: none;
            gap: 4px;
        }

        .session-item:hover .session-item-actions {
            display: flex;
        }

        .session-action-btn {
            padding: 4px 8px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }

        .session-action-btn:hover {
            background: #f1f5f9;
        }

        .session-action-btn.delete:hover {
            background: #fef2f2;
            border-color: #ef4444;
            color: #ef4444;
        }

        .sidebar.collapsed .session-item {
            padding: 12px 4px;
            text-align: center;
        }

        .sidebar.collapsed .session-item-title,
        .sidebar.collapsed .session-item-info,
        .sidebar.collapsed .session-item-actions {
            display: none;
        }

        .toggle-sidebar {
            padding: 10px;
            background: none;
            border: none;
            cursor: pointer;
            color: #64748b;
            transition: color 0.2s;
        }

        .toggle-sidebar:hover {
            color: #667eea;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .session-title-display {
            font-size: 13px;
            opacity: 0.9;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        .status-dot.disconnected {
            background: #ef4444;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .config-panel {
            padding: 10px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .config-panel.collapsed {
            display: none;
        }

        .config-panel input {
            padding: 6px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 13px;
            flex: 1;
            min-width: 150px;
        }

        .config-panel button {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .config-panel button:hover {
            background: #5a67d8;
        }

        .config-panel button:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        .workspace-panel {
            padding: 8px 20px;
            background: #f0fdf4;
            border-bottom: 1px solid #bbf7d0;
            display: none;
        }

        .workspace-panel.visible {
            display: block;
        }

        .workspace-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .workspace-info-text {
            font-size: 12px;
            color: #166534;
        }

        .workspace-options {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .workspace-option {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .workspace-option input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
        }

        .workspace-option input[type="text"] {
            padding: 4px 8px;
            border: 1px solid #86efac;
            border-radius: 4px;
            font-size: 12px;
            width: 180px;
        }

        .workspace-option label {
            cursor: pointer;
            user-select: none;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8fafc;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.assistant .avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .message.user .avatar {
            background: #e2e8f0;
        }

        .message-content {
            max-width: 70%;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message.assistant .message-bubble {
            background: white;
            border: 1px solid #e2e8f0;
            border-top-left-radius: 4px;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-top-right-radius: 4px;
        }

        .message-meta {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #cbd5e1;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .input-container {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
        }

        .input-wrapper textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            max-height: 120px;
        }

        .input-wrapper textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .send-button:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quick-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .quick-action {
            padding: 5px 10px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action:hover {
            background: #e2e8f0;
            border-color: #cbd5e1;
        }

        .tool-use {
            background: #fef3c7;
            border-left: 3px solid #f59e0b;
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 4px;
            font-size: 13px;
        }

        .tool-use strong {
            color: #92400e;
        }

        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
        }

        .error-message {
            background: #fef2f2;
            border-left: 3px solid #ef4444;
            padding: 12px;
            border-radius: 6px;
            color: #991b1b;
        }

        .system-message {
            text-align: center;
            color: #64748b;
            font-size: 12px;
            margin: 10px 0;
        }

        .progress-message {
            font-size: 12px;
            color: #6366f1;
            margin: 4px 0;
            padding: 4px 8px;
            background: #f1f5f9;
            border-left: 2px solid #6366f1;
            border-radius: 4px;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .tool-start {
            background: #dbeafe;
            border-left: 3px solid #3b82f6;
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-start::before {
            content: 'ğŸ”§';
            font-size: 14px;
        }

        .tool-complete {
            background: #d1fae5;
            border-left: 3px solid #10b981;
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-complete::before {
            content: 'âœ…';
            font-size: 14px;
        }

        .tool-error {
            background: #fee2e2;
            border-left: 3px solid #ef4444;
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-error::before {
            content: 'âŒ';
            font-size: 14px;
        }

        .think-message {
            font-style: italic;
            color: #7c3aed;
            background: #f3e8ff;
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 4px;
            font-size: 12px;
            border-left: 2px solid #a855f7;
        }

        .think-message::before {
            content: 'ğŸ’­ ';
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3 {
            margin: 12px 0 8px;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .markdown-content code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }

        .markdown-content a {
            color: #667eea;
            text-decoration: none;
            border-bottom: 1px solid #667eea;
            transition: all 0.2s;
        }

        .markdown-content a:hover {
            color: #764ba2;
            border-bottom-color: #764ba2;
            background: #f3e8ff;
        }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal h3 {
            margin-bottom: 16px;
            color: #334155;
        }

        .modal input {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .modal input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .modal-button.primary {
            background: #667eea;
            color: white;
        }

        .modal-button.secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .modal-button:hover {
            opacity: 0.9;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .session-list::-webkit-scrollbar,
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .session-list::-webkit-scrollbar-track,
        .chat-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .session-list::-webkit-scrollbar-thumb,
        .chat-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .session-list::-webkit-scrollbar-thumb:hover,
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .loading-sessions {
            padding: 20px;
            text-align: center;
            color: #94a3b8;
            font-size: 13px;
        }

        .empty-sessions {
            padding: 20px;
            text-align: center;
            color: #94a3b8;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ’¬ ä¼šè¯</h2>
                <button class="toggle-sidebar" onclick="toggleSidebar()" title="æŠ˜å /å±•å¼€ä¾§è¾¹æ ">
                    â—€
                </button>
            </div>
            <button class="new-chat-btn" onclick="createNewSession()">
                â• <span>æ–°å»ºä¼šè¯</span>
            </button>
            <div class="session-list" id="sessionList">
                <div class="loading-sessions">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div class="header">
                <div class="header-left">
                    <div class="status">
                        <span class="status-dot" id="statusDot"></span>
                        <span id="statusText">æœªè¿æ¥</span>
                    </div>
                    <div class="session-title-display" id="sessionTitleDisplay">æ–°ä¼šè¯</div>
                </div>
                <div class="header-right">
                    <button class="config-panel-toggle" onclick="toggleConfigPanel()" style="padding: 6px 12px; background: rgba(255,255,255,0.2); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">âš™ï¸ è®¾ç½®</button>
                </div>
            </div>

            <div class="config-panel" id="configPanel">
                <input type="text" id="serverUrl" placeholder="æœåŠ¡å™¨ URL" value="http://localhost:4096">
                <input type="text" id="username" placeholder="ç”¨æˆ·å" value="opencode" style="max-width: 120px;">
                <input type="password" id="password" placeholder="å¯†ç ï¼ˆå¯é€‰ï¼‰" style="max-width: 120px;">
                <button onclick="connectToServer()">è¿æ¥</button>
                <button onclick="loadSessions()" style="background: #10b981;">ğŸ”„ åˆ·æ–°ä¼šè¯</button>
            </div>

            <div class="workspace-panel" id="workspacePanel">
                <div class="workspace-info">
                    <div class="workspace-info-text">
                        ğŸ“ å·¥ä½œç©ºé—´: <span id="workspacePath">-</span>
                    </div>
                </div>
                <div class="workspace-options">
                    <div class="workspace-option">
                        <input type="checkbox" id="autoCreateProject" checked>
                        <label for="autoCreateProject">è‡ªåŠ¨åˆ›å»ºé¡¹ç›®</label>
                    </div>
                    <div class="workspace-option">
                        <label for="customProjectName">é¡¹ç›®åç§°:</label>
                        <input type="text" id="customProjectName" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                    </div>
                </div>
            </div>

            <div class="chat-container" id="chatContainer">
                <div class="system-message">æ¬¢è¿ä½¿ç”¨ OpenCode Web Client</div>
                <div class="system-message">è¯·å…ˆé…ç½®æœåŠ¡å™¨åœ°å€å¹¶è¿æ¥</div>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <textarea
                        id="messageInput"
                        placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯... (Shift+Enter æ¢è¡Œ, Enter å‘é€)"
                        rows="3"
                        onkeydown="handleKeyPress(event)"
                    ></textarea>
                    <button class="send-button" id="sendButton" onclick="sendMessage()" disabled>å‘é€</button>
                </div>
                <div class="quick-actions">
                    <button class="quick-action" onclick="sendQuickMessage('å¸®æˆ‘åˆ—å‡ºå½“å‰ç›®å½•çš„æ–‡ä»¶')">åˆ—å‡ºæ–‡ä»¶</button>
                    <button class="quick-action" onclick="sendQuickMessage('åˆ›å»ºä¸€ä¸ªç®€å•çš„ REST API')">åˆ›å»º API</button>
                    <button class="quick-action" onclick="sendQuickMessage('å¸®æˆ‘å†™ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹')">å†™æµ‹è¯•</button>
                    <button class="quick-action" onclick="sendQuickMessage('å¸®æˆ‘ä¿®å¤è¿™ä¸ª bug')">ä¿®å¤ Bug</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é‡å‘½åæ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="renameModal">
        <div class="modal">
            <h3>é‡å‘½åä¼šè¯</h3>
            <input type="text" id="renameInput" placeholder="è¾“å…¥æ–°çš„ä¼šè¯åç§°">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeRenameModal()">å–æ¶ˆ</button>
                <button class="modal-button primary" onclick="confirmRename()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script>
        let serverUrl = 'http://localhost:4096';
        let username = 'opencode';
        let password = '';
        let isConnected = false;
        let eventSource = null;
        let currentSessionId = null;
        let pendingMessages = new Map();
        let messageCounter = 0;
        let messageDisplayMap = new Map();
        let sessions = [];
        let sidebarCollapsed = false;

        // ä» localStorage åŠ è½½é…ç½®
        function loadConfig() {
            serverUrl = localStorage.getItem('opencode_server_url') || 'http://localhost:4096';
            username = localStorage.getItem('opencode_username') || 'opencode';
            password = localStorage.getItem('opencode_password') || '';

            document.getElementById('serverUrl').value = serverUrl;
            document.getElementById('username').value = username;
            document.getElementById('password').value = password;
        }

        // ä¿å­˜é…ç½®åˆ° localStorage
        function saveConfig() {
            serverUrl = document.getElementById('serverUrl').value;
            username = document.getElementById('username').value;
            password = document.getElementById('password').value;

            localStorage.setItem('opencode_server_url', serverUrl);
            localStorage.setItem('opencode_username', username);
            localStorage.setItem('opencode_password', password);
        }

        // è·å–è®¤è¯å¤´
        function getAuthHeaders() {
            const headers = {
                'Content-Type': 'application/json'
            };
            if (username && password) {
                headers['Authorization'] = 'Basic ' + btoa(username + ':' + password);
            }
            return headers;
        }

        // è¿æ¥åˆ°æœåŠ¡å™¨
        async function connectToServer() {
            saveConfig();

            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const sendButton = document.getElementById('sendButton');

            statusDot.className = 'status-dot';
            statusText.textContent = 'è¿æ¥ä¸­...';
            sendButton.disabled = true;

            try {
                // æµ‹è¯•è¿æ¥
                const response = await fetch(`${serverUrl}/remote/health`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('æœåŠ¡å™¨è¿æ¥æˆåŠŸ:', data);

                    isConnected = true;
                    statusDot.className = 'status-dot';
                    statusText.textContent = 'å·²è¿æ¥';
                    sendButton.disabled = false;

                    // æ˜¾ç¤ºå·¥ä½œç©ºé—´ä¿¡æ¯
                    if (data.workspace) {
                        document.getElementById('workspacePath').textContent = data.workspace;
                        document.getElementById('workspacePanel').classList.add('visible');
                    }

                    // è¿æ¥ SSE äº‹ä»¶æµ
                    connectEventStream();

                    // åŠ è½½ä¼šè¯åˆ—è¡¨
                    await loadSessions();

                    addSystemMessage('å·²è¿æ¥åˆ°æœåŠ¡å™¨ ' + serverUrl);
                } else {
                    throw new Error('è¿æ¥å¤±è´¥: ' + response.status);
                }
            } catch (error) {
                console.error('è¿æ¥é”™è¯¯:', error);
                isConnected = false;
                statusDot.className = 'status-dot disconnected';
                statusText.textContent = 'è¿æ¥å¤±è´¥';
                sendButton.disabled = true;

                addSystemMessage('è¿æ¥å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½ä¼šè¯åˆ—è¡¨
        async function loadSessions() {
            if (!isConnected) {
                console.log('æœªè¿æ¥ï¼Œæ— æ³•åŠ è½½ä¼šè¯');
                return;
            }

            try {
                const response = await fetch(`${serverUrl}/remote/execute`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        type: 'status'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data && result.data.sessions) {
                        sessions = result.data.sessions;
                        renderSessionList();
                        console.log('å·²åŠ è½½', sessions.length, 'ä¸ªä¼šè¯');
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ä¼šè¯å¤±è´¥:', error);
                document.getElementById('sessionList').innerHTML =
                    '<div class="empty-sessions">åŠ è½½å¤±è´¥</div>';
            }
        }

        // æ¸²æŸ“ä¼šè¯åˆ—è¡¨
        function renderSessionList() {
            const sessionList = document.getElementById('sessionList');

            if (sessions.length === 0) {
                sessionList.innerHTML = '<div class="empty-sessions">æš‚æ— ä¼šè¯</div>';
                return;
            }

            sessionList.innerHTML = sessions.map(session => `
                <div class="session-item ${session.id === currentSessionId ? 'active' : ''}"
                     onclick="switchSession('${session.id}')"
                     title="${escapeHtml(session.title || 'æœªå‘½åä¼šè¯')}">
                    <div class="session-item-title">${escapeHtml(session.title || 'æœªå‘½åä¼šè¯')}</div>
                    <div class="session-item-info">
                        <span>${formatTime(session.time)}</span>
                    </div>
                    <div class="session-item-actions">
                        <button class="session-action-btn" onclick="event.stopPropagation(); showRenameModal('${session.id}')">é‡å‘½å</button>
                        <button class="session-action-btn delete" onclick="event.stopPropagation(); deleteSession('${session.id}')">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // æ–°å»ºä¼šè¯
        function createNewSession() {
            if (!isConnected) {
                alert('è¯·å…ˆè¿æ¥æœåŠ¡å™¨');
                return;
            }

            currentSessionId = null;
            document.getElementById('sessionTitleDisplay').textContent = 'æ–°ä¼šè¯';
            document.getElementById('chatContainer').innerHTML = `
                <div class="system-message">å·²åˆ›å»ºæ–°ä¼šè¯</div>
                <div class="system-message">å¼€å§‹ä½ çš„å¯¹è¯å§...</div>
            `;

            // æ›´æ–°ä¼šè¯åˆ—è¡¨çš„é«˜äº®çŠ¶æ€
            renderSessionList();
        }

        // åˆ‡æ¢ä¼šè¯
        async function switchSession(sessionId) {
            if (!isConnected) {
                alert('è¯·å…ˆè¿æ¥æœåŠ¡å™¨');
                return;
            }

            currentSessionId = sessionId;

            // æŸ¥æ‰¾ä¼šè¯ä¿¡æ¯
            const session = sessions.find(s => s.id === sessionId);
            if (session) {
                document.getElementById('sessionTitleDisplay').textContent = session.title || 'æœªå‘½åä¼šè¯';
            }

            // åŠ è½½ä¼šè¯æ¶ˆæ¯
            try {
                // æ¸…ç©ºèŠå¤©åŒºåŸŸ
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML = '';

                // æ˜¾ç¤ºåŠ è½½ä¸­æç¤º
                addSystemMessage(`æ­£åœ¨åŠ è½½ä¼šè¯: ${session?.title || 'æœªå‘½åä¼šè¯'}...`);

                // è·å–å†å²æ¶ˆæ¯
                const response = await fetch(`${serverUrl}/remote/messages/${sessionId}`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        // æ˜¾ç¤ºæ¶ˆæ¯æ•°é‡
                        addSystemMessage(`å·²åŠ è½½ ${result.data.length} æ¡å†å²æ¶ˆæ¯`);

                        // æ¸²æŸ“å†å²æ¶ˆæ¯
                        for (const message of result.data) {
                            await renderMessage(message);
                        }

                        // æ»šåŠ¨åˆ°åº•éƒ¨
                        scrollToBottom();
                    }
                } else {
                    addSystemMessage('åŠ è½½å†å²æ¶ˆæ¯å¤±è´¥: ' + response.status);
                }

                // æ›´æ–°ä¼šè¯åˆ—è¡¨é«˜äº®
                renderSessionList();
            } catch (error) {
                console.error('åˆ‡æ¢ä¼šè¯å¤±è´¥:', error);
                addSystemMessage('åˆ‡æ¢ä¼šè¯å¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“å•æ¡æ¶ˆæ¯
        async function renderMessage(message) {
            if (!message.info) return;

            const { info, parts } = message;
            const isUser = info.role === 'user';

            if (isUser) {
                // æ¸²æŸ“ç”¨æˆ·æ¶ˆæ¯
                const userText = getTextFromParts(parts);
                addUserMessage(userText);
            } else {
                // æ¸²æŸ“ AI æ¶ˆæ¯
                const displayId = `msg-${info.id}`;
                const messageDiv = createAssistantMessage(displayId, '');

                // æ¸²æŸ“æ‰€æœ‰ parts
                if (parts && parts.length > 0) {
                    const contentDiv = messageDiv.querySelector('.message-content');

                    for (const part of parts) {
                        await renderPart(contentDiv, part);
                    }
                }
            }
        }

        // ä» parts ä¸­æå–æ–‡æœ¬å†…å®¹
        function getTextFromParts(parts) {
            if (!parts || parts.length === 0) return '';

            const textParts = parts.filter(p => p.type === 'text');
            return textParts.map(p => p.text || '').join('\n');
        }

        // æ¸²æŸ“æ¶ˆæ¯çš„ part
        async function renderPart(container, part) {
            switch (part.type) {
                case 'text':
                    if (part.text) {
                        const textDiv = document.createElement('div');
                        textDiv.innerHTML = formatMarkdown(part.text);
                        container.appendChild(textDiv);
                    }
                    break;

                case 'tool':
                    const toolDiv = document.createElement('div');
                    toolDiv.className = 'progress-message';
                    toolDiv.innerHTML = `<span style="color: #94a3b8; font-size: 11px;">[${formatTimestamp(part.time?.created)}]</span> ğŸ”§ æ‰§è¡Œå·¥å…·: ${part.tool}`;
                    container.appendChild(toolDiv);
                    break;

                case 'file-read':
                    const fileReadDiv = document.createElement('div');
                    fileReadDiv.className = 'progress-message';
                    fileReadDiv.innerHTML = `ğŸ“– è¯»å–æ–‡ä»¶: ${part.path || part.filename || ''}`;
                    container.appendChild(fileReadDiv);
                    break;

                case 'file-write':
                    const fileWriteDiv = document.createElement('div');
                    fileWriteDiv.className = 'progress-message';
                    fileWriteDiv.innerHTML = `âœï¸  å†™å…¥æ–‡ä»¶: ${part.path || part.filename || ''}`;
                    container.appendChild(fileWriteDiv);
                    break;

                case 'shell':
                    if (part.state?.command) {
                        const shellDiv = document.createElement('div');
                        shellDiv.className = 'progress-message';
                        shellDiv.innerHTML = `ğŸ’» æ‰§è¡Œ: ${part.state.command}`;
                        container.appendChild(shellDiv);
                    }
                    break;

                case 'think':
                    if (part.text) {
                        const thinkDiv = document.createElement('div');
                        thinkDiv.className = 'think-message';
                        thinkDiv.textContent = part.text.substring(0, 200);
                        container.appendChild(thinkDiv);
                    }
                    break;

                default:
                    // å…¶ä»–ç±»å‹çš„ partï¼Œæ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
                    if (part.type) {
                        const defaultDiv = document.createElement('div');
                        defaultDiv.className = 'progress-message';
                        defaultDiv.style.fontSize = '11px';
                        defaultDiv.style.color = '#94a3b8';
                        defaultDiv.textContent = `[${part.type}]`;
                        container.appendChild(defaultDiv);
                    }
                    break;
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´æˆ³
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // åˆ é™¤ä¼šè¯
        async function deleteSession(sessionId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼šè¯å—ï¼Ÿ')) {
                return;
            }

            try {
                // æ³¨æ„ï¼šOpenCode API å¯èƒ½æ²¡æœ‰åˆ é™¤ä¼šè¯çš„ç«¯ç‚¹
                // è¿™é‡Œåªæ˜¯ä»åˆ—è¡¨ä¸­ç§»é™¤æ˜¾ç¤º
                sessions = sessions.filter(s => s.id !== sessionId);
                renderSessionList();

                if (currentSessionId === sessionId) {
                    createNewSession();
                }

                addSystemMessage('ä¼šè¯å·²åˆ é™¤ï¼ˆä»…æœ¬åœ°åˆ—è¡¨ï¼‰');
            } catch (error) {
                console.error('åˆ é™¤ä¼šè¯å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºé‡å‘½åæ¨¡æ€æ¡†
        let renamingSessionId = null;
        function showRenameModal(sessionId) {
            renamingSessionId = sessionId;
            const session = sessions.find(s => s.id === sessionId);
            document.getElementById('renameInput').value = session?.title || '';
            document.getElementById('renameModal').classList.add('show');
            document.getElementById('renameInput').focus();
        }

        // å…³é—­é‡å‘½åæ¨¡æ€æ¡†
        function closeRenameModal() {
            document.getElementById('renameModal').classList.remove('show');
            renamingSessionId = null;
        }

        // ç¡®è®¤é‡å‘½å
        async function confirmRename() {
            const newName = document.getElementById('renameInput').value.trim();
            if (!newName || !renamingSessionId) {
                closeRenameModal();
                return;
            }

            try {
                // æ³¨æ„ï¼šOpenCode API å¯èƒ½æ²¡æœ‰é‡å‘½åä¼šè¯çš„ç«¯ç‚¹
                // è¿™é‡Œåªæ˜¯æ›´æ–°æœ¬åœ°åˆ—è¡¨
                const session = sessions.find(s => s.id === renamingSessionId);
                if (session) {
                    session.title = newName;
                    renderSessionList();

                    if (currentSessionId === renamingSessionId) {
                        document.getElementById('sessionTitleDisplay').textContent = newName;
                    }
                }

                closeRenameModal();
                addSystemMessage('ä¼šè¯å·²é‡å‘½åï¼ˆä»…æœ¬åœ°ï¼‰');
            } catch (error) {
                console.error('é‡å‘½åå¤±è´¥:', error);
            }
        }

        // è¿æ¥ SSE äº‹ä»¶æµ
        function connectEventStream() {
            if (eventSource) {
                eventSource.close();
            }

            let eventUrl = `${serverUrl}/event`;

            if (username && password) {
                const auth = btoa(username + ':' + password);
                eventUrl += `?auth=${encodeURIComponent(auth)}`;
            }

            eventSource = new EventSource(eventUrl);

            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('æ”¶åˆ°äº‹ä»¶:', data);
                    handleEvent(data);
                } catch (e) {
                    console.error('è§£æäº‹ä»¶å¤±è´¥:', e);
                }
            };

            eventSource.onerror = (error) => {
                console.error('SSE é”™è¯¯:', error);
            };

            eventSource.onopen = () => {
                console.log('SSE è¿æ¥å·²å»ºç«‹');
            };
        }

        // å¤„ç†äº‹ä»¶
        function handleEvent(event) {
            const { type, properties } = event;

            switch (type) {
                case 'server.connected':
                    addSystemMessage('äº‹ä»¶æµå·²è¿æ¥');
                    break;

                case 'server.heartbeat':
                    break;

                case 'message.part.updated':
                    handlePartUpdated(properties);
                    break;

                case 'session.error':
                    handleError(properties);
                    break;

                case 'session.idle':
                    hideTypingIndicator();
                    break;

                default:
                    console.log('æœªå¤„ç†çš„äº‹ä»¶ç±»å‹:', type);
            }
        }

        // å¤„ç†æ¶ˆæ¯éƒ¨åˆ†æ›´æ–°
        function handlePartUpdated(part) {
            if (!part.sessionID) return;

            const messageID = part.messageID || part.id;
            const key = part.sessionID + ':' + messageID;
            let displayId = messageDisplayMap.get(key);

            if (!displayId) {
                displayId = messageDisplayMap.get(part.sessionID) || part.sessionID;
            }

            switch (part.type) {
                case 'text':
                    if (part.state?.text) {
                        updateAssistantMessage(displayId, part.state.text, part.state.end);
                    }
                    break;

                case 'tool':
                    if (part.state?.status === 'started') {
                        addToolStart(displayId, part.tool, part.state);
                    } else if (part.state?.status === 'completed') {
                        addToolComplete(displayId, part.tool, part.state);
                    } else if (part.state?.status === 'failed') {
                        addToolError(displayId, part.tool, part.state);
                    }
                    break;

                case 'step-start':
                    showTypingIndicator();
                    addProgressMessage(displayId, 'ğŸ”„ å¼€å§‹å¤„ç†...');
                    break;

                case 'step-end':
                    addProgressMessage(displayId, 'âœ… æ‰§è¡Œå®Œæˆ');
                    break;

                case 'file-read':
                    addProgressMessage(displayId, `ğŸ“– è¯»å–æ–‡ä»¶: ${part.path || part.filename || ''}`);
                    break;

                case 'file-write':
                    addProgressMessage(displayId, `âœï¸  å†™å…¥æ–‡ä»¶: ${part.path || part.filename || ''}`);
                    break;

                case 'shell':
                    if (part.state?.command) {
                        addProgressMessage(displayId, `ğŸ’» æ‰§è¡Œ: ${part.state.command}`);
                    }
                    break;

                case 'think':
                    if (part.state?.text) {
                        addThinkMessage(displayId, part.state.text);
                    }
                    break;

                default:
                    console.log('æœªå¤„ç†çš„äº‹ä»¶ç±»å‹:', part.type, part);
            }
        }

        // æ›´æ–°åŠ©æ‰‹æ¶ˆæ¯
        function updateAssistantMessage(sessionId, text, isComplete) {
            let messageDiv = document.getElementById(`msg-${sessionId}`);

            if (!messageDiv) {
                messageDiv = createAssistantMessage(sessionId, '');
                document.getElementById('chatContainer').appendChild(messageDiv);
            }

            const contentDiv = messageDiv.querySelector('.message-bubble');
            contentDiv.innerHTML = formatMarkdown(text);

            if (isComplete) {
                hideTypingIndicator();
                scrollToBottom();
            } else {
                scrollToBottom();
            }
        }

        // åˆ›å»ºåŠ©æ‰‹æ¶ˆæ¯å…ƒç´ 
        function createAssistantMessage(sessionId, initialText = '') {
            const existingDiv = document.getElementById(`msg-${sessionId}`);
            if (existingDiv) {
                return existingDiv;
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.id = `msg-${sessionId}`;
            messageDiv.innerHTML = `
                <div class="avatar">ğŸ¤–</div>
                <div class="message-content">
                    <div class="message-bubble markdown-content">${formatMarkdown(initialText)}</div>
                </div>
            `;
            document.getElementById('chatContainer').appendChild(messageDiv);
            scrollToBottom();
            return messageDiv;
        }

        // å¤„ç†é”™è¯¯
        function handleError(properties) {
            if (!properties.sessionID || !properties.error) return;

            let messageDiv = document.getElementById(`msg-${properties.sessionID}`);

            if (!messageDiv) {
                messageDiv = createAssistantMessage(properties.sessionID, '');
                document.getElementById('chatContainer').appendChild(messageDiv);
            }

            const contentDiv = messageDiv.querySelector('.message-content');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = 'é”™è¯¯: ' + (
                properties.error.data?.message ||
                properties.error.message ||
                String(properties.error)
            );
            contentDiv.appendChild(errorDiv);

            hideTypingIndicator();
            scrollToBottom();
        }

        // æ˜¾ç¤º typing æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            let indicator = document.getElementById('typing-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'typing-indicator';
                indicator.className = 'message assistant';
                indicator.innerHTML = `
                    <div class="avatar">ğŸ¤–</div>
                    <div class="message-content">
                        <div class="typing-indicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                `;
                document.getElementById('chatContainer').appendChild(indicator);
            }
            scrollToBottom();
        }

        // éšè— typing æŒ‡ç¤ºå™¨
        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // æ ¼å¼åŒ– Markdown
        function formatMarkdown(text) {
            if (!text) return '';

            const codeBlocks = [];
            let processedText = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                codeBlocks.push(`<div class="code-block"><pre><code>${escapeHtml(code.trim())}</code></pre></div>`);
                return `__CODEBLOCK_${codeBlocks.length - 1}__`;
            });

            const inlineCodes = [];
            processedText = processedText.replace(/`([^`]+)`/g, (match, code) => {
                inlineCodes.push(`<code>${escapeHtml(code)}</code>`);
                return `__INLINECODE_${inlineCodes.length - 1}__`;
            });

            const markdownLinks = [];
            processedText = processedText.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
                markdownLinks.push(`<a href="${url}" target="_blank">${text}</a>`);
                return `__MDLINK_${markdownLinks.length - 1}__`;
            });

            processedText = processedText.replace(
                /(https?:\/\/[^\s<>]+|www\.[^\s<>]+)/g,
                '<a href="$1" target="_blank">$1</a>'
            );

            processedText = processedText.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            processedText = processedText.replace(/\*([^*]+)\*/g, '<em>$1</em>');

            markdownLinks.forEach((link, i) => {
                processedText = processedText.replace(`__MDLINK_${i}__`, link);
            });

            inlineCodes.forEach((code, i) => {
                processedText = processedText.replace(`__INLINECODE_${i}__`, code);
            });

            codeBlocks.forEach((block, i) => {
                processedText = processedText.replace(`__CODEBLOCK_${i}__`, block);
            });

            processedText = processedText.replace(/\n/g, '<br>');

            return processedText;
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message || !isConnected) return;

            const displayId = 'msg-' + Date.now() + '-' + (++messageCounter);
            addUserMessage(message);
            input.value = '';
            document.getElementById('sendButton').disabled = true;

            try {
                showTypingIndicator();

                const autoCreateProject = document.getElementById('autoCreateProject').checked;
                const customProjectName = document.getElementById('customProjectName').value.trim();

                const requestBody = {
                    type: 'prompt',
                    message: message,
                    sessionID: currentSessionId || undefined,
                    autoCreateProject: autoCreateProject,
                    projectName: customProjectName || undefined
                };

                const response = await fetch(`${serverUrl}/remote/execute`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }

                const result = await response.json();

                if (result.success) {
                    currentSessionId = result.sessionID;
                    console.log('æ¶ˆæ¯å·²å‘é€, ä¼šè¯ ID:', currentSessionId, 'æ¶ˆæ¯ ID:', result.messageID);

                    if (result.messageID) {
                        messageDisplayMap.set(currentSessionId + ':' + result.messageID, displayId);
                    }

                    createAssistantMessage(displayId, '');
                    addProgressMessage(displayId, 'â³ æ¶ˆæ¯å·²æ¥æ”¶ï¼Œæ­£åœ¨å¤„ç†...');
                    hideTypingIndicator();

                    if (result.projectDir) {
                        addSystemMessage('ğŸ“ é¡¹ç›®ç›®å½•: ' + result.projectDir);
                    }

                    // åˆ·æ–°ä¼šè¯åˆ—è¡¨
                    await loadSessions();

                    if (result.data && result.data.parts) {
                        for (const part of result.data.parts) {
                            if (part.type === 'text' && part.text) {
                                updateAssistantMessage(displayId, part.text, true);
                            }
                        }
                    }
                } else {
                    throw new Error(result.error || 'å‘é€å¤±è´¥');
                }
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                hideTypingIndicator();
                addSystemMessage('å‘é€å¤±è´¥: ' + error.message);
            } finally {
                document.getElementById('sendButton').disabled = false;
                document.getElementById('messageInput').focus();
            }
        }

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        function addUserMessage(text) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <div class="avatar">ğŸ‘¤</div>
                <div class="message-content">
                    <div class="message-bubble">${escapeHtml(text)}</div>
                    <div class="message-meta">${getCurrentTime()}</div>
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(text) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'system-message';
            messageDiv.textContent = text;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // æ·»åŠ è¿›åº¦æ¶ˆæ¯
        function addProgressMessage(sessionId, text) {
            let messageDiv = document.getElementById(`msg-${sessionId}`);

            if (!messageDiv) {
                messageDiv = createAssistantMessage(sessionId, '');
            }

            const contentDiv = messageDiv.querySelector('.message-content');
            const progressDiv = document.createElement('div');
            progressDiv.className = 'progress-message';
            progressDiv.innerHTML = `<span style="color: #94a3b8; font-size: 11px;">[${getCurrentTime()}]</span> ${text}`;
            contentDiv.appendChild(progressDiv);
            scrollToBottom();
        }

        // æ·»åŠ å·¥å…·å¼€å§‹
        function addToolStart(sessionId, toolName, state) {
            addProgressMessage(sessionId, `ğŸ”§ æ‰§è¡Œå·¥å…·: ${toolName}`);
            if (state.input) {
                addProgressMessage(sessionId, `   å‚æ•°: ${JSON.stringify(state.input).substring(0, 100)}`);
            }
        }

        // æ·»åŠ å·¥å…·å®Œæˆ
        function addToolComplete(sessionId, toolName, state) {
            addProgressMessage(sessionId, `âœ… å·¥å…·å®Œæˆ: ${toolName}`);
            if (state.output) {
                const output = state.output;
                if (typeof output === 'string' && output.length > 0) {
                    addProgressMessage(sessionId, `   è¾“å‡º: ${output.substring(0, 100)}${output.length > 100 ? '...' : ''}`);
                }
            }
        }

        // æ·»åŠ å·¥å…·é”™è¯¯
        function addToolError(sessionId, toolName, state) {
            addProgressMessage(sessionId, `âŒ å·¥å…·å¤±è´¥: ${toolName}`);
            if (state.error) {
                addProgressMessage(sessionId, `   é”™è¯¯: ${state.error}`);
            }
        }

        // æ·»åŠ æ€è€ƒæ¶ˆæ¯
        function addThinkMessage(sessionId, text) {
            let messageDiv = document.getElementById(`msg-${sessionId}`);

            if (!messageDiv) {
                messageDiv = createAssistantMessage(sessionId, '');
            }

            const contentDiv = messageDiv.querySelector('.message-content');
            const thinkDiv = document.createElement('div');
            thinkDiv.className = 'think-message';
            thinkDiv.textContent = text.substring(0, 200);
            contentDiv.appendChild(thinkDiv);
            scrollToBottom();
        }

        // å‘é€å¿«æ·æ¶ˆæ¯
        function sendQuickMessage(message) {
            document.getElementById('messageInput').value = message;
            sendMessage();
        }

        // å¤„ç†æŒ‰é”®
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // è·å–å½“å‰æ—¶é—´
        function getCurrentTime() {
            return new Date().toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // æ ¼å¼åŒ–æ—¶é—´æˆ³
        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'åˆšåˆš';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'å¤©å‰';

            return date.toLocaleDateString('zh-CN');
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åˆ‡æ¢ä¾§è¾¹æ 
        function toggleSidebar() {
            sidebarCollapsed = !sidebarCollapsed;
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.querySelector('.toggle-sidebar');

            if (sidebarCollapsed) {
                sidebar.classList.add('collapsed');
                toggleBtn.textContent = 'â–¶';
            } else {
                sidebar.classList.remove('collapsed');
                toggleBtn.textContent = 'â—€';
            }
        }

        // åˆ‡æ¢é…ç½®é¢æ¿
        function toggleConfigPanel() {
            const panel = document.getElementById('configPanel');
            panel.classList.toggle('collapsed');
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            loadConfig();
        };

        // é¡µé¢å¸è½½æ—¶å…³é—­è¿æ¥
        window.onbeforeunload = function() {
            if (eventSource) {
                eventSource.close();
            }
        };

        // æ¨¡æ€æ¡†é”®ç›˜äº‹ä»¶
        document.getElementById('renameInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                confirmRename();
            } else if (e.key === 'Escape') {
                closeRenameModal();
            }
        });
    </script>
</body>
</html>
