<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenCode Web Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 900px;
            height: 90vh;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        .status-dot.disconnected {
            background: #ef4444;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .config-panel {
            padding: 15px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .config-panel input {
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
            flex: 1;
            min-width: 200px;
        }

        .config-panel button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .config-panel button:hover {
            background: #5a67d8;
        }

        .config-panel button:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        .workspace-panel {
            padding: 10px 20px;
            background: #f0fdf4;
            border-bottom: 1px solid #bbf7d0;
            display: none;
        }

        .workspace-panel.visible {
            display: block;
        }

        .workspace-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .workspace-info-text {
            font-size: 13px;
            color: #166534;
        }

        .workspace-options {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .workspace-option {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .workspace-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .workspace-option input[type="text"] {
            padding: 6px 10px;
            border: 1px solid #86efac;
            border-radius: 4px;
            font-size: 13px;
            width: 200px;
        }

        .workspace-option label {
            cursor: pointer;
            user-select: none;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8fafc;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.assistant .avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .message.user .avatar {
            background: #e2e8f0;
        }

        .message-content {
            max-width: 70%;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message.assistant .message-bubble {
            background: white;
            border: 1px solid #e2e8f0;
            border-top-left-radius: 4px;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-top-right-radius: 4px;
        }

        .message-meta {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #cbd5e1;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
        }

        .input-wrapper textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            max-height: 120px;
        }

        .input-wrapper textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .send-button:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quick-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .quick-action {
            padding: 6px 12px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action:hover {
            background: #e2e8f0;
            border-color: #cbd5e1;
        }

        .tool-use {
            background: #fef3c7;
            border-left: 3px solid #f59e0b;
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 4px;
            font-size: 13px;
        }

        .tool-use strong {
            color: #92400e;
        }

        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
        }

        .error-message {
            background: #fef2f2;
            border-left: 3px solid #ef4444;
            padding: 12px;
            border-radius: 6px;
            color: #991b1b;
        }

        .system-message {
            text-align: center;
            color: #64748b;
            font-size: 12px;
            margin: 10px 0;
        }

        .progress-message {
            font-size: 12px;
            color: #6366f1;
            margin: 4px 0;
            padding: 4px 8px;
            background: #f1f5f9;
            border-left: 2px solid #6366f1;
            border-radius: 4px;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .tool-start {
            background: #dbeafe;
            border-left: 3px solid #3b82f6;
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-start::before {
            content: 'ğŸ”§';
            font-size: 14px;
        }

        .tool-complete {
            background: #d1fae5;
            border-left: 3px solid #10b981;
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-complete::before {
            content: 'âœ…';
            font-size: 14px;
        }

        .tool-error {
            background: #fee2e2;
            border-left: 3px solid #ef4444;
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-error::before {
            content: 'âŒ';
            font-size: 14px;
        }

        .think-message {
            font-style: italic;
            color: #7c3aed;
            background: #f3e8ff;
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 4px;
            font-size: 12px;
            border-left: 2px solid #a855f7;
        }

        .think-message::before {
            content: 'ğŸ’­ ';
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3 {
            margin: 12px 0 8px;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .markdown-content code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– OpenCode Web Client</h1>
            <div class="status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">è¿æ¥ä¸­...</span>
            </div>
        </div>

        <div class="config-panel">
            <input type="text" id="serverUrl" placeholder="æœåŠ¡å™¨ URL" value="http://localhost:4096">
            <input type="text" id="username" placeholder="ç”¨æˆ·å" value="opencode" style="max-width: 150px;">
            <input type="password" id="password" placeholder="å¯†ç ï¼ˆå¯é€‰ï¼‰" style="max-width: 150px;">
            <button onclick="connectToServer()">è¿æ¥</button>
        </div>

        <div class="workspace-panel" id="workspacePanel">
            <div class="workspace-info">
                <div class="workspace-info-text">
                    ğŸ“ å·¥ä½œç©ºé—´: <span id="workspacePath">-</span>
                </div>
            </div>
            <div class="workspace-options">
                <div class="workspace-option">
                    <input type="checkbox" id="autoCreateProject" checked>
                    <label for="autoCreateProject">è‡ªåŠ¨åˆ›å»ºé¡¹ç›®</label>
                </div>
                <div class="workspace-option">
                    <label for="customProjectName">é¡¹ç›®åç§°:</label>
                    <input type="text" id="customProjectName" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                </div>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="system-message">æ¬¢è¿ä½¿ç”¨ OpenCode Web Client</div>
            <div class="system-message">è¯·å…ˆé…ç½®æœåŠ¡å™¨åœ°å€å¹¶è¿æ¥ï¼Œç„¶åå¼€å§‹å¯¹è¯</div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <textarea
                    id="messageInput"
                    placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯... (Shift+Enter æ¢è¡Œ, Enter å‘é€)"
                    rows="3"
                    onkeydown="handleKeyPress(event)"
                ></textarea>
                <button class="send-button" id="sendButton" onclick="sendMessage()" disabled>å‘é€</button>
            </div>
            <div class="quick-actions">
                <button class="quick-action" onclick="sendQuickMessage('å¸®æˆ‘åˆ—å‡ºå½“å‰ç›®å½•çš„æ–‡ä»¶')">åˆ—å‡ºæ–‡ä»¶</button>
                <button class="quick-action" onclick="sendQuickMessage('åˆ›å»ºä¸€ä¸ªç®€å•çš„ REST API')">åˆ›å»º API</button>
                <button class="quick-action" onclick="sendQuickMessage('å¸®æˆ‘å†™ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹')">å†™æµ‹è¯•</button>
                <button class="quick-action" onclick="sendQuickMessage('å¸®æˆ‘ä¿®å¤è¿™ä¸ª bug')">ä¿®å¤ Bug</button>
            </div>
        </div>
    </div>

    <script>
        let serverUrl = 'http://localhost:4096';
        let username = 'opencode';
        let password = '';
        let isConnected = false;
        let eventSource = null;
        let currentSessionId = null;
        let pendingMessages = new Map();
        let messageCounter = 0;  // ç”¨äºç”Ÿæˆå”¯ä¸€çš„æ¶ˆæ¯æ˜¾ç¤º ID
        let messageDisplayMap = new Map();  // sessionID -> displayId æ˜ å°„

        // ä» localStorage åŠ è½½é…ç½®
        function loadConfig() {
            serverUrl = localStorage.getItem('opencode_server_url') || 'http://localhost:4096';
            username = localStorage.getItem('opencode_username') || 'opencode';
            password = localStorage.getItem('opencode_password') || '';

            document.getElementById('serverUrl').value = serverUrl;
            document.getElementById('username').value = username;
            document.getElementById('password').value = password;
        }

        // ä¿å­˜é…ç½®åˆ° localStorage
        function saveConfig() {
            serverUrl = document.getElementById('serverUrl').value;
            username = document.getElementById('username').value;
            password = document.getElementById('password').value;

            localStorage.setItem('opencode_server_url', serverUrl);
            localStorage.setItem('opencode_username', username);
            localStorage.setItem('opencode_password', password);
        }

        // è·å–è®¤è¯å¤´
        function getAuthHeaders() {
            const headers = {
                'Content-Type': 'application/json'
            };
            if (username && password) {
                headers['Authorization'] = 'Basic ' + btoa(username + ':' + password);
            }
            return headers;
        }

        // è¿æ¥åˆ°æœåŠ¡å™¨
        async function connectToServer() {
            saveConfig();

            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const sendButton = document.getElementById('sendButton');

            statusDot.className = 'status-dot';
            statusText.textContent = 'è¿æ¥ä¸­...';
            sendButton.disabled = true;

            try {
                // æµ‹è¯•è¿æ¥
                const response = await fetch(`${serverUrl}/remote/health`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('æœåŠ¡å™¨è¿æ¥æˆåŠŸ:', data);

                    isConnected = true;
                    statusDot.className = 'status-dot';
                    statusText.textContent = 'å·²è¿æ¥';
                    sendButton.disabled = false;

                    // æ˜¾ç¤ºå·¥ä½œç©ºé—´ä¿¡æ¯
                    if (data.workspace) {
                        document.getElementById('workspacePath').textContent = data.workspace;
                        document.getElementById('workspacePanel').classList.add('visible');
                    }

                    // è¿æ¥ SSE äº‹ä»¶æµ
                    connectEventStream();

                    addSystemMessage('å·²è¿æ¥åˆ°æœåŠ¡å™¨ ' + serverUrl);
                    addSystemMessage('å·¥ä½œç©ºé—´: ' + data.workspace);
                } else {
                    throw new Error('è¿æ¥å¤±è´¥: ' + response.status);
                }
            } catch (error) {
                console.error('è¿æ¥é”™è¯¯:', error);
                isConnected = false;
                statusDot.className = 'status-dot disconnected';
                statusText.textContent = 'è¿æ¥å¤±è´¥';
                sendButton.disabled = true;

                addSystemMessage('è¿æ¥å¤±è´¥: ' + error.message);
            }
        }

        // è¿æ¥ SSE äº‹ä»¶æµ
        function connectEventStream() {
            if (eventSource) {
                eventSource.close();
            }

            let eventUrl = `${serverUrl}/event`;

            // å¦‚æœæœ‰å¯†ç ï¼Œæ·»åŠ è®¤è¯
            if (username && password) {
                const auth = btoa(username + ':' + password);
                // æ³¨æ„ï¼šSSE ä¸æ”¯æŒè‡ªå®šä¹‰ headerï¼Œéœ€è¦é€šè¿‡ URL ä¼ é€’
                eventUrl += `?auth=${encodeURIComponent(auth)}`;
            }

            eventSource = new EventSource(eventUrl);

            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('æ”¶åˆ°äº‹ä»¶:', data);
                    handleEvent(data);
                } catch (e) {
                    console.error('è§£æäº‹ä»¶å¤±è´¥:', e);
                }
            };

            eventSource.onerror = (error) => {
                console.error('SSE é”™è¯¯:', error);
                // å¦‚æœæ˜¯åŸºæœ¬è®¤è¯é—®é¢˜ï¼Œæç¤ºç”¨æˆ·
                if (password) {
                    addSystemMessage('æ³¨æ„ï¼šSSE å¯èƒ½ä¸æ”¯æŒåŸºæœ¬è®¤è¯ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½å—é™');
                }
            };

            eventSource.onopen = () => {
                console.log('SSE è¿æ¥å·²å»ºç«‹');
            };
        }

        // å¤„ç†äº‹ä»¶
        function handleEvent(event) {
            const { type, properties } = event;

            switch (type) {
                case 'server.connected':
                    addSystemMessage('äº‹ä»¶æµå·²è¿æ¥');
                    break;

                case 'server.heartbeat':
                    // å¿ƒè·³äº‹ä»¶ï¼Œå¿½ç•¥
                    break;

                case 'message.part.updated':
                    handlePartUpdated(properties);
                    break;

                case 'session.error':
                    handleError(properties);
                    break;

                case 'session.idle':
                    hideTypingIndicator();
                    break;

                default:
                    console.log('æœªå¤„ç†çš„äº‹ä»¶ç±»å‹:', type);
            }
        }

        // å¤„ç†æ¶ˆæ¯éƒ¨åˆ†æ›´æ–°
        function handlePartUpdated(part) {
            if (!part.sessionID) return;

            // æŸ¥æ‰¾å¯¹åº”çš„ displayId
            const messageID = part.messageID || part.id;
            const key = part.sessionID + ':' + messageID;
            let displayId = messageDisplayMap.get(key);

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ˜ å°„ï¼Œä½¿ç”¨ sessionIDï¼ˆå‘åå…¼å®¹ï¼‰
            if (!displayId) {
                displayId = messageDisplayMap.get(part.sessionID) || part.sessionID;
            }

            // å¤„ç†ä¸åŒç±»å‹çš„äº‹ä»¶
            switch (part.type) {
                case 'text':
                    // AI çš„æ–‡æœ¬å›å¤
                    if (part.state?.text) {
                        updateAssistantMessage(displayId, part.state.text, part.state.end);
                    }
                    break;

                case 'tool':
                    // å·¥å…·è°ƒç”¨
                    if (part.state?.status === 'started') {
                        addToolStart(displayId, part.tool, part.state);
                    } else if (part.state?.status === 'completed') {
                        addToolComplete(displayId, part.tool, part.state);
                    } else if (part.state?.status === 'failed') {
                        addToolError(displayId, part.tool, part.state);
                    }
                    break;

                case 'step-start':
                    // å¼€å§‹æ‰§è¡Œ
                    showTypingIndicator();
                    addProgressMessage(displayId, 'ğŸ”„ å¼€å§‹å¤„ç†...');
                    break;

                case 'step-end':
                    // æ‰§è¡Œç»“æŸ
                    addProgressMessage(displayId, 'âœ… æ‰§è¡Œå®Œæˆ');
                    break;

                case 'file-read':
                    // æ–‡ä»¶è¯»å–
                    addProgressMessage(displayId, `ğŸ“– è¯»å–æ–‡ä»¶: ${part.path || part.filename || ''}`);
                    break;

                case 'file-write':
                    // æ–‡ä»¶å†™å…¥
                    addProgressMessage(displayId, `âœï¸  å†™å…¥æ–‡ä»¶: ${part.path || part.filename || ''}`);
                    break;

                case 'shell':
                    // Shell å‘½ä»¤æ‰§è¡Œ
                    if (part.state?.command) {
                        addProgressMessage(displayId, `ğŸ’» æ‰§è¡Œ: ${part.state.command}`);
                    }
                    break;

                case 'think':
                    // AI æ€è€ƒ
                    if (part.state?.text) {
                        addThinkMessage(displayId, part.state.text);
                    }
                    break;

                default:
                    console.log('æœªå¤„ç†çš„äº‹ä»¶ç±»å‹:', part.type, part);
            }
        }

        // æ›´æ–°åŠ©æ‰‹æ¶ˆæ¯
        function updateAssistantMessage(sessionId, text, isComplete) {
            let messageDiv = document.getElementById(`msg-${sessionId}`);

            if (!messageDiv) {
                messageDiv = createAssistantMessage(sessionId, '');
                document.getElementById('chatContainer').appendChild(messageDiv);
            }

            const contentDiv = messageDiv.querySelector('.message-bubble');
            contentDiv.innerHTML = formatMarkdown(text);

            if (isComplete) {
                hideTypingIndicator();
                scrollToBottom();
            } else {
                scrollToBottom();
            }
        }

        // åˆ›å»ºåŠ©æ‰‹æ¶ˆæ¯å…ƒç´ 
        function createAssistantMessage(sessionId, initialText = '') {
            const existingDiv = document.getElementById(`msg-${sessionId}`);
            if (existingDiv) {
                return existingDiv;  // å¦‚æœå·²å­˜åœ¨ï¼Œè¿”å›ç°æœ‰å…ƒç´ 
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.id = `msg-${sessionId}`;
            messageDiv.innerHTML = `
                <div class="avatar">ğŸ¤–</div>
                <div class="message-content">
                    <div class="message-bubble markdown-content">${formatMarkdown(initialText)}</div>
                </div>
            `;
            document.getElementById('chatContainer').appendChild(messageDiv);
            scrollToBottom();
            return messageDiv;
        }

        // æ·»åŠ å·¥å…·ä½¿ç”¨ä¿¡æ¯
        function addToolUse(sessionId, toolName, state) {
            let messageDiv = document.getElementById(`msg-${sessionId}`);

            if (!messageDiv) {
                messageDiv = createAssistantMessage(sessionId, '');
                document.getElementById('chatContainer').appendChild(messageDiv);
            }

            const contentDiv = messageDiv.querySelector('.message-content');
            const toolDiv = document.createElement('div');
            toolDiv.className = 'tool-use';

            const title = state.title || (Object.keys(state.input || {}).length > 0
                ? JSON.stringify(state.input)
                : toolName);

            toolDiv.innerHTML = `<strong>ä½¿ç”¨å·¥å…·:</strong> ${toolName}<br><strong>å‚æ•°:</strong> ${title}`;

            if (state.output) {
                const outputDiv = document.createElement('div');
                outputDiv.className = 'code-block';
                outputDiv.textContent = state.output;
                toolDiv.appendChild(outputDiv);
            }

            contentDiv.appendChild(toolDiv);
            scrollToBottom();
        }

        // å¤„ç†é”™è¯¯
        function handleError(properties) {
            if (!properties.sessionID || !properties.error) return;

            let messageDiv = document.getElementById(`msg-${properties.sessionID}`);

            if (!messageDiv) {
                messageDiv = createAssistantMessage(properties.sessionID, '');
                document.getElementById('chatContainer').appendChild(messageDiv);
            }

            const contentDiv = messageDiv.querySelector('.message-content');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = 'é”™è¯¯: ' + (
                properties.error.data?.message ||
                properties.error.message ||
                String(properties.error)
            );
            contentDiv.appendChild(errorDiv);

            hideTypingIndicator();
            scrollToBottom();
        }

        // æ˜¾ç¤º typing æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            let indicator = document.getElementById('typing-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'typing-indicator';
                indicator.className = 'message assistant';
                indicator.innerHTML = `
                    <div class="avatar">ğŸ¤–</div>
                    <div class="message-content">
                        <div class="typing-indicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                `;
                document.getElementById('chatContainer').appendChild(indicator);
            }
            scrollToBottom();
        }

        // éšè— typing æŒ‡ç¤ºå™¨
        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // æ ¼å¼åŒ– Markdown (ç®€å•ç‰ˆæœ¬)
        function formatMarkdown(text) {
            if (!text) return '';

            return text
                // ä»£ç å—
                .replace(/```(\w+)?\n([\s\S]*?)```/g, '<div class="code-block"><pre><code>$2</code></pre></div>')
                // è¡Œå†…ä»£ç 
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // ç²—ä½“
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                // æ–œä½“
                .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                // é“¾æ¥
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
                // æ¢è¡Œ
                .replace(/\n/g, '<br>');
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message || !isConnected) return;

            // ç”Ÿæˆå”¯ä¸€çš„æ¶ˆæ¯æ˜¾ç¤º ID
            const displayId = 'msg-' + Date.now() + '-' + (++messageCounter);

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
            addUserMessage(message);

            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';

            // ç¦ç”¨å‘é€æŒ‰é’®
            document.getElementById('sendButton').disabled = true;

            try {
                showTypingIndicator();

                // è·å–å·¥ä½œç©ºé—´é€‰é¡¹
                const autoCreateProject = document.getElementById('autoCreateProject').checked;
                const customProjectName = document.getElementById('customProjectName').value.trim();

                // ä½¿ç”¨å½“å‰ä¼šè¯ ID æˆ–åˆ›å»ºæ–°ä¼šè¯
                const requestBody = {
                    type: 'prompt',
                    message: message,
                    sessionID: currentSessionId || undefined,
                    autoCreateProject: autoCreateProject,
                    projectName: customProjectName || undefined
                };

                const response = await fetch(`${serverUrl}/remote/execute`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }

                const result = await response.json();

                if (result.success) {
                    // ä¿å­˜ä¼šè¯ ID
                    currentSessionId = result.sessionID;
                    console.log('æ¶ˆæ¯å·²å‘é€, ä¼šè¯ ID:', currentSessionId, 'æ¶ˆæ¯ ID:', result.messageID);

                    // æ˜ å°„ sessionID + messageID åˆ° displayId
                    if (result.messageID) {
                        messageDisplayMap.set(currentSessionId + ':' + result.messageID, displayId);
                    }

                    // ä½¿ç”¨ displayId åˆ›å»º AI å›å¤æ¶ˆæ¯å…ƒç´ 
                    createAssistantMessage(displayId, '');

                    // ç«‹å³æ˜¾ç¤ºæ¥æ”¶ç¡®è®¤
                    addProgressMessage(displayId, 'â³ æ¶ˆæ¯å·²æ¥æ”¶ï¼Œæ­£åœ¨å¤„ç†...');

                    // éšè— typing æŒ‡ç¤ºå™¨
                    hideTypingIndicator();

                    // æ˜¾ç¤ºé¡¹ç›®ç›®å½•ä¿¡æ¯
                    if (result.projectDir) {
                        addSystemMessage('ğŸ“ é¡¹ç›®ç›®å½•: ' + result.projectDir);
                    }

                    // å¦‚æœæœ‰ç«‹å³è¿”å›çš„æ•°æ®ï¼Œæ˜¾ç¤ºå®ƒ
                    if (result.data && result.data.parts) {
                        for (const part of result.data.parts) {
                            if (part.type === 'text' && part.text) {
                                updateAssistantMessage(displayId, part.text, true);
                            }
                        }
                    }
                } else {
                    throw new Error(result.error || 'å‘é€å¤±è´¥');
                }
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                hideTypingIndicator();
                addSystemMessage('å‘é€å¤±è´¥: ' + error.message);
            } finally {
                // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
                document.getElementById('sendButton').disabled = false;
                document.getElementById('messageInput').focus();
            }
        }

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        function addUserMessage(text) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <div class="avatar">ğŸ‘¤</div>
                <div class="message-content">
                    <div class="message-bubble">${escapeHtml(text)}</div>
                    <div class="message-meta">${getCurrentTime()}</div>
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(text) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'system-message';
            messageDiv.textContent = text;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // æ·»åŠ è¿›åº¦æ¶ˆæ¯
        function addProgressMessage(sessionId, text) {
            let messageDiv = document.getElementById(`msg-${sessionId}`);

            if (!messageDiv) {
                messageDiv = createAssistantMessage(sessionId, '');
            }

            const contentDiv = messageDiv.querySelector('.message-content');
            const progressDiv = document.createElement('div');
            progressDiv.className = 'progress-message';
            progressDiv.innerHTML = `<span style="color: #94a3b8; font-size: 11px;">[${getCurrentTime()}]</span> ${text}`;
            contentDiv.appendChild(progressDiv);
            scrollToBottom();
        }

        // æ·»åŠ å·¥å…·å¼€å§‹
        function addToolStart(sessionId, toolName, state) {
            addProgressMessage(sessionId, `ğŸ”§ æ‰§è¡Œå·¥å…·: ${toolName}`);
            if (state.input) {
                addProgressMessage(sessionId, `   å‚æ•°: ${JSON.stringify(state.input).substring(0, 100)}`);
            }
        }

        // æ·»åŠ å·¥å…·å®Œæˆ
        function addToolComplete(sessionId, toolName, state) {
            addProgressMessage(sessionId, `âœ… å·¥å…·å®Œæˆ: ${toolName}`);
            if (state.output) {
                const output = state.output;
                if (typeof output === 'string' && output.length > 0) {
                    addProgressMessage(sessionId, `   è¾“å‡º: ${output.substring(0, 100)}${output.length > 100 ? '...' : ''}`);
                }
            }
        }

        // æ·»åŠ å·¥å…·é”™è¯¯
        function addToolError(sessionId, toolName, state) {
            addProgressMessage(sessionId, `âŒ å·¥å…·å¤±è´¥: ${toolName}`);
            if (state.error) {
                addProgressMessage(sessionId, `   é”™è¯¯: ${state.error}`);
            }
        }

        // æ·»åŠ æ€è€ƒæ¶ˆæ¯
        function addThinkMessage(sessionId, text) {
            let messageDiv = document.getElementById(`msg-${sessionId}`);

            if (!messageDiv) {
                messageDiv = createAssistantMessage(sessionId, '');
            }

            const contentDiv = messageDiv.querySelector('.message-content');
            const thinkDiv = document.createElement('div');
            thinkDiv.className = 'think-message';
            thinkDiv.textContent = text.substring(0, 200);
            contentDiv.appendChild(thinkDiv);
            scrollToBottom();
        }

        // å‘é€å¿«æ·æ¶ˆæ¯
        function sendQuickMessage(message) {
            document.getElementById('messageInput').value = message;
            sendMessage();
        }

        // å¤„ç†æŒ‰é”®
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // è·å–å½“å‰æ—¶é—´
        function getCurrentTime() {
            return new Date().toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            loadConfig();
            // è‡ªåŠ¨è¿æ¥
            if (localStorage.getItem('opencode_auto_connect') === 'true') {
                connectToServer();
            }
        };

        // é¡µé¢å¸è½½æ—¶å…³é—­è¿æ¥
        window.onbeforeunload = function() {
            if (eventSource) {
                eventSource.close();
            }
        };
    </script>
</body>
</html>
